<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handschriftart Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            position: relative;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header p {
            opacity: 0.95;
            font-size: 1.2em;
            position: relative;
        }

        .steps {
            display: flex;
            justify-content: space-around;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .step.active .step-number {
            background: #764ba2;
            box-shadow: 0 0 0 4px rgba(118, 75, 162, 0.2);
        }

        .content {
            padding: 40px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .char-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .char-btn {
            aspect-ratio: 1;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: white;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .char-btn:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .char-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 10px 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.5);
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        .template-preview {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .char-preview {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: white;
        }

        .char-preview img {
            max-width: 100%;
            height: 120px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .char-label {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .test-input {
            width: 100%;
            padding: 20px;
            font-size: 2em;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin: 10px 0;
        }

        .actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-template, .print-template * {
                visibility: visible;
            }
            .print-template {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úçÔ∏è Handschriftart Creator</h1>
            <p>Erstelle deinen eigenen Font aus deiner Handschrift</p>
        </div>

        <div class="steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div>Zeichen w√§hlen</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div>Template (optional)</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div>Zeichnen</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div>Font speichern</div>
            </div>
        </div>

        <div class="content">
            <!-- Schritt 1: Zeichen w√§hlen -->
            <div class="section active" id="step1">
                <h2>Schritt 1: W√§hle die Zeichen f√ºr deinen Font</h2>
                <p style="margin: 20px 0;">W√§hle die Zeichen aus, die du in deinem Font haben m√∂chtest:</p>
                
                <h3 style="margin-top: 30px;">Gro√übuchstaben</h3>
                <div class="char-grid" id="uppercase-grid"></div>
                
                <h3 style="margin-top: 30px;">Kleinbuchstaben</h3>
                <div class="char-grid" id="lowercase-grid"></div>
                
                <h3 style="margin-top: 30px;">Zahlen</h3>
                <div class="char-grid" id="numbers-grid"></div>
                
                <h3 style="margin-top: 30px;">Sonderzeichen</h3>
                <div class="char-grid" id="special-grid"></div>

                <h3 style="margin-top: 30px;">Erweiterte Lateinische Zeichen (inkl. PL, CZ, SK, EO, HU, RO, TR)</h3>
                <div class="char-grid" id="extended-grid"></div>

                <h3 style="margin-top: 30px;">Deutsche Sonderzeichen</h3>
                <div class="char-grid" id="german-grid"></div>

                <h3 style="margin-top: 30px;">W√§hrungssymbole</h3>
                <div class="char-grid" id="currency-grid"></div>

                <h3 style="margin-top: 30px;">Mathematische Symbole</h3>
                <div class="char-grid" id="math-grid"></div>

                <h3 style="margin-top: 30px;">Griechische Buchstaben</h3>
                <div class="char-grid" id="greek-grid"></div>

                <h3 style="margin-top: 30px;">Kyrillische Buchstaben</h3>
                <div class="char-grid" id="cyrillic-grid"></div>

                <h3 style="margin-top: 30px;">Pfeile</h3>
                <div class="char-grid" id="arrows-grid"></div>

                <h3 style="margin-top: 30px;">Interpunktion & Anf√ºhrungszeichen</h3>
                <div class="char-grid" id="punctuation-grid"></div>

                <h3 style="margin-top: 30px;">Br√ºche</h3>
                <div class="char-grid" id="fractions-grid"></div>

                <h3 style="margin-top: 30px;">Hochgestellt</h3>
                <div class="char-grid" id="superscript-grid"></div>

                <h3 style="margin-top: 30px;">Tiefgestellt</h3>
                <div class="char-grid" id="subscript-grid"></div>

                <h3 style="margin-top: 30px;">Symbole</h3>
                <div class="char-grid" id="symbols-grid"></div>

                <h3 style="margin-top: 30px;">Formen</h3>
                <div class="char-grid" id="shapes-grid"></div>

                <h3 style="margin-top: 30px;">Emoji</h3>
                <div class="char-grid" id="emoji-grid"></div>

                <div class="actions">
                    <button class="btn btn-secondary" onclick="selectAll()">Alle ausw√§hlen</button>
                    <button class="btn btn-secondary" onclick="deselectAll()">Alle abw√§hlen</button>
                    <button class="btn btn-secondary" onclick="selectBasic()">Nur Basis (A-Z, a-z, 0-9)</button>
                    <button class="btn btn-secondary" onclick="selectExtended()">Mit Umlauten</button>
                    <button class="btn btn-primary" onclick="goToStep(2)">Weiter zum Template ‚Üí</button>
                </div>
            </div>

            <!-- Schritt 2: Template -->
            <div class="section" id="step2">
                <h2>Schritt 2: Template drucken (Optional)</h2>
                <p style="margin: 20px 0;">Optional: Drucke ein Template zum √úben. Du kannst die Zeichen auch direkt digital im n√§chsten Schritt zeichnen.</p>
                
                <div class="template-preview">
                    <p><strong>üìÑ Template ist bereit zum Drucken</strong></p>
                    <p style="margin-top: 10px; color: #666;">
                        Enth√§lt <span id="char-count">0</span> Zeichen
                    </p>
                </div>

                <div class="actions">
                    <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Zur√ºck</button>
                    <button class="btn btn-secondary" onclick="printTemplate()">üñ®Ô∏è Template drucken</button>
                    <button class="btn btn-secondary" onclick="downloadTemplate()">üíæ Als PDF herunterladen</button>
                    <button class="btn btn-primary" onclick="goToStep(3)">√úberspringen / Weiter zum Zeichnen ‚Üí</button>
                </div>
            </div>

            <!-- Schritt 3: Zeichnen -->
            <div class="section" id="step3">
                <h2>Schritt 3: Zeichne deine Zeichen</h2>
                <p style="margin: 20px 0;">Zeichne jedes Zeichen in den Canvas. Die Zeichen werden als SVG gespeichert:</p>

                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 16px; margin: 20px 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                    <div>
                        <h3 style="margin: 0; color: #495057; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px;">Aktuelles Zeichen</h3>
                        <div id="current-char" style="font-size: 5em; color: #667eea; margin-top: 10px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">A</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #6c757d; margin-bottom: 8px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px;">Fortschritt</div>
                        <div style="font-size: 2.5em; font-weight: bold; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            <span id="progress-count">0</span> / <span id="total-count">0</span>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin: 40px 0; position: relative;">
                    <div style="display: inline-block; position: relative;">
                        <canvas id="draw-canvas" width="600" height="600" 
                                style="border: 4px solid #667eea; border-radius: 20px; cursor: crosshair; background: white; max-width: 100%; touch-action: none; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.25);"></canvas>
                        <div id="pen-indicator" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.9em; display: none; backdrop-filter: blur(10px);">
                            üñäÔ∏è Stift erkannt
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);">
                        <button class="btn btn-secondary" onclick="toggleEraser()" id="eraser-btn" style="font-size: 1.1em;">
                            üßπ Radierer
                        </button>
                        <button class="btn btn-secondary" onclick="clearCanvas()" style="font-size: 1.1em;">üóëÔ∏è Alles l√∂schen</button>
                        <button class="btn btn-secondary" onclick="undoStroke()" style="font-size: 1.1em;">‚Ü∂ R√ºckg√§ngig</button>
                        <br>
                        <div style="display: inline-flex; align-items: center; margin-top: 15px; padding: 10px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <span style="margin-right: 15px; font-weight: 600; color: #495057;">Gr√∂√üe:</span>
                            <input type="range" id="brush-size" min="2" max="20" value="8" 
                                   style="width: 200px; vertical-align: middle; cursor: pointer;">
                            <span id="brush-size-label" style="margin-left: 15px; font-weight: 600; color: #667eea;">8px</span>
                        </div>
                    </div>
                </div>

                <div class="actions">
                    <button class="btn btn-secondary" onclick="previousChar()">‚Üê Vorheriges</button>
                    <button class="btn btn-secondary" onclick="skipChar()">√úberspringen</button>
                    <button class="btn btn-primary" onclick="saveCharAndNext()">Speichern & Weiter ‚Üí</button>
                </div>

                <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 16px; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);">
                    <h3 style="color: #2e7d32; margin-bottom: 15px;">‚úÖ Bereits gezeichnet</h3>
                    <div id="drawn-chars" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                </div>

                <div style="margin-top: 20px; padding: 25px; background: linear-gradient(135deg, #fff9e6 0%, #ffe9b3 100%); border-radius: 16px; border: 3px solid #ffc107; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);">
                    <h3 style="color: #f57f17; margin-bottom: 15px;">üìã Alle Zeichen (zum Anspringen)</h3>
                    <div id="all-chars-nav" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>
            </div>

            <!-- Schritt 4: Font speichern -->
            <div class="section" id="step4">
                <h2>Schritt 4: Deinen Font speichern</h2>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 10px; margin: 20px 0;">
                    <h3>Font-Name:</h3>
                    <input type="text" id="font-name" value="Meine Handschrift" 
                           style="width: 100%; padding: 15px; font-size: 1.2em; border: 2px solid #e9ecef; border-radius: 8px; margin: 10px 0;">
                    
                    <p style="margin-top: 20px; color: #666;">
                        Deine gezeichneten Zeichen werden als SVG-Dateien in einer ZIP-Datei gespeichert.
                        Diese kannst du dann mit FontForge, Glyphs oder Calligraphr.com in einen echten Font umwandeln.
                    </p>
                </div>

                <h3 style="margin: 30px 0 20px 0;">Vorschau deiner Zeichen:</h3>
                <div class="preview-grid" id="final-preview"></div>

                <div class="actions">
                    <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Zur√ºck</button>
                    <button class="btn btn-primary" onclick="downloadFont()">
                        üíæ Font als ZIP herunterladen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-template" class="print-template" style="display: none;"></div>

    <script>
        // Character sets
        const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
        const lowercase = 'abcdefghijklmnopqrstuvwxyz'.split('');
        const numbers = '0123456789'.split('');
        const special = ['.',',','!','?',';',':','-','(',')','{','}','[',']','@','#','$','%','&','*','+','=','<','>','/','\\'];
        const extendedLatin = 'A√Å√Ç√É√Ñ√Ö√ÜƒÑƒÄƒÇƒÑƒÜ√áƒàƒäƒåƒéƒê√êE√à√â√ä√ãƒñƒòƒöGƒúƒûHƒ§I√å√ç√é√èƒ∞ƒÆJƒ¥KL≈ÅMN≈É≈á√ëO√í√ì√î√ï√ñ√ò≈íPQR≈î≈òS≈ö≈†≈ûT≈§U√ô√ö√õ√ú≈∞≈ÆVWX√ùY≈∏Z≈π≈Ω≈ªa√°√¢√£√§√•√¶ƒÖƒáƒÅƒÉƒáƒçƒâƒãƒçƒèƒë√∞e√®√©√™√´ƒóƒôƒõgƒùƒühƒ•i√¨√≠√Æ√ØiÃáƒØjƒµkl≈Çmn≈Ñ≈à√±o√≤√≥√¥√µ√∂√∏≈ìpqr≈ï≈ôs≈õ≈°≈üt≈•u√π√∫√ª√º≈±≈Øvwx√Ωy√øz≈∫≈æ≈º'.split('');
        const germanSpecial = '√§√∂√º√ü√Ñ√ñ√ú'.split('');
        const currency = '‚Ç¨$¬£¬•¬¢‚Çπ‚ÇΩ‚Ç©‚Ç™‚Ç®‚Ç±‚Ç°‚Ç¥‚Çµ‚Ç∏‚Ç∫‚Çº‚Çæ'.split('');
        const math = '√ó√∑¬±‚â†‚â§‚â•‚àû‚àö‚àë‚àè‚à´‚àÇ‚àÜ‚àá‚âà¬∞'.split('');
        const greek = 'Œ±Œ≤Œ≥Œ¥ŒµŒ∂Œ∑Œ∏ŒπŒ∫ŒªŒºŒΩŒæŒøœÄœÅœÉœÑœÖœÜœáœàœâŒëŒíŒìŒîŒïŒñŒóŒòŒôŒöŒõŒúŒùŒûŒüŒ†Œ°Œ£Œ§Œ•Œ¶ŒßŒ®Œ©'.split('');
        const cyrillic = '–∞–±–≤–≥–¥–µ–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è–ê–ë–í–ì–î–ï–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø'.split('');
        const arrows = '‚Üê‚Üí‚Üë‚Üì‚Üî‚Üï‚Üñ‚Üó‚Üò‚Üô‚áê‚áí‚áë‚áì‚áî‚áï'.split('');
        const punctuation = ['\u201E','\u201C','\u201D','\u2018','\u2019','\u201A','\u2039','\u203A','\u00AB','\u00BB','\u2013','\u2014','\u2026','\u00B7','\u2022','\u2030','\u2031'];
        const fractions = '¬º¬Ω¬æ‚Öì‚Öî‚Öõ‚Öú‚Öù‚Öû'.split('');
        const superscript = '‚Å∞¬π¬≤¬≥‚Å¥‚Åµ‚Å∂‚Å∑‚Å∏‚Åπ‚Å∫‚Åª‚Åº‚ÅΩ‚Åæ‚Åø'.split('');
        const subscript = '‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ‚Çä‚Çã‚Çå‚Çç‚Çé'.split('');
        const symbols = '¬©¬Æ‚Ñ¢¬ß¬∂‚Ä†‚Ä°¬∞‚Ä≤‚Ä≥‚Ä∞‚Ä±‚Ññ‚ÑÉ‚Ñâ'.split('');
        const shapes = '‚ñ†‚ñ°‚ñ™‚ñ´‚óè‚óã‚óÜ‚óá‚òÖ‚òÜ‚ô†‚ô£‚ô•‚ô¶'.split('');
        const emoji = 'üòÄüòÅüòÇüòÉüòÑüòÖüòÜüòäüòçü§îüéâüé®üéµüé∂üí°üìù‚úÖ‚ùå'.split('');
        
        let selectedChars = new Set();
        let uploadedImages = {};

        // Canvas drawing variables
        let canvas, ctx;
        let isDrawing = false;
        let currentStrokes = [];
        let allStrokes = [];
        let charsSvgData = {};
        let currentCharIndex = 0;
        let charsToDrawArray = [];
        let isEraserMode = false;

        // Initialize character grids
        function initGrids() {
            createGrid('uppercase-grid', uppercase);
            createGrid('lowercase-grid', lowercase);
            createGrid('numbers-grid', numbers);
            createGrid('special-grid', special);
            createGrid('extended-grid', extendedLatin);
            createGrid('german-grid', germanSpecial);
            createGrid('currency-grid', currency);
            createGrid('math-grid', math);
            createGrid('greek-grid', greek);
            createGrid('cyrillic-grid', cyrillic);
            createGrid('arrows-grid', arrows);
            createGrid('punctuation-grid', punctuation);
            createGrid('fractions-grid', fractions);
            createGrid('superscript-grid', superscript);
            createGrid('subscript-grid', subscript);
            createGrid('symbols-grid', symbols);
            createGrid('shapes-grid', shapes);
            createGrid('emoji-grid', emoji);
        }

        function createGrid(id, chars) {
            const grid = document.getElementById(id);
            chars.forEach(char => {
                const btn = document.createElement('button');
                btn.className = 'char-btn';
                btn.textContent = char;
                btn.onclick = () => toggleChar(char, btn);
                grid.appendChild(btn);
            });
        }

        function toggleChar(char, btn) {
            if (selectedChars.has(char)) {
                selectedChars.delete(char);
                btn.classList.remove('selected');
            } else {
                selectedChars.add(char);
                btn.classList.add('selected');
            }
            updateCharCount();
        }

        function selectAll() {
            selectedChars = new Set([
                ...uppercase, ...lowercase, ...numbers, ...special, 
                ...extendedLatin, ...germanSpecial, ...currency, ...math,
                ...greek, ...cyrillic, ...arrows, ...punctuation,
                ...fractions, ...superscript, ...subscript, ...symbols,
                ...shapes, ...emoji
            ]);
            document.querySelectorAll('.char-btn').forEach(btn => btn.classList.add('selected'));
            updateCharCount();
        }

        function deselectAll() {
            selectedChars.clear();
            document.querySelectorAll('.char-btn').forEach(btn => btn.classList.remove('selected'));
            updateCharCount();
        }

        function selectBasic() {
            deselectAll();
            selectedChars = new Set([...uppercase, ...lowercase, ...numbers]);
            updateSelectedButtons();
            updateCharCount();
        }

        function selectExtended() {
            deselectAll();
            selectedChars = new Set([
                ...uppercase, ...lowercase, ...numbers, 
                ...germanSpecial, ...extendedLatin, ...special, 
                ...punctuation, ...currency
            ]);
            updateSelectedButtons();
            updateCharCount();
        }

        function updateSelectedButtons() {
            document.querySelectorAll('.char-btn').forEach(btn => {
                if (selectedChars.has(btn.textContent)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        function updateCharCount() {
            const countEl = document.getElementById('char-count');
            if (countEl) {
                countEl.textContent = selectedChars.size;
            }
        }

        function goToStep(step) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            document.getElementById('step' + step).classList.add('active');
            document.querySelector('.step[data-step="' + step + '"]').classList.add('active');
            
            if (step === 3) {
                setTimeout(() => {
                    initCanvas();
                    initDrawingStep();
                }, 100);
            } else if (step === 4) {
                displayFinalPreview();
            }
        }

        function printTemplate() {
            generateTemplate();
            setTimeout(() => window.print(), 100);
        }

        function downloadTemplate() {
            generateTemplate();
            alert('Verwende Strg+P (oder Cmd+P auf Mac) und w√§hle "Als PDF speichern"');
            window.print();
        }

        function generateTemplate() {
            const container = document.getElementById('print-template');
            container.style.display = 'block';
            container.innerHTML = '';
            
            // Sort characters by Unicode value
            const chars = Array.from(selectedChars).sort((a, b) => a.charCodeAt(0) - b.charCodeAt(0));
            const charsPerPage = 12;
            const pages = Math.ceil(chars.length / charsPerPage);
            
            for (let p = 0; p < pages; p++) {
                const page = document.createElement('div');
                page.style.cssText = 'page-break-after: always; padding: 30px; font-family: Arial, sans-serif; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column;';
                
                const title = document.createElement('h1');
                title.textContent = 'Handschriftart Template - Seite ' + (p + 1) + '/' + pages;
                title.style.cssText = 'text-align: center; margin-bottom: 15px; color: #667eea; font-size: 24px;';
                page.appendChild(title);
                
                const instructions = document.createElement('p');
                instructions.textContent = 'Schreibe jeden Buchstaben in das entsprechende K√§stchen. Verwende einen schwarzen Stift und schreibe klar und deutlich.';
                instructions.style.cssText = 'text-align: center; margin-bottom: 25px; color: #666; font-size: 14px;';
                page.appendChild(instructions);
                
                const grid = document.createElement('div');
                grid.style.cssText = 'display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; flex: 1; align-content: start;';
                
                const pageChars = chars.slice(p * charsPerPage, (p + 1) * charsPerPage);
                
                pageChars.forEach(char => {
                    const cell = document.createElement('div');
                    cell.style.cssText = 'border: 3px solid #333; padding: 15px; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-between; box-sizing: border-box;';
                    
                    const label = document.createElement('div');
                    label.textContent = char;
                    label.style.cssText = 'font-size: 20px; font-weight: bold; color: #999;';
                    
                    const writeArea = document.createElement('div');
                    writeArea.style.cssText = 'width: 100%; flex: 1; border-bottom: 2px solid #ccc; margin-top: 10px;';
                    
                    cell.appendChild(label);
                    cell.appendChild(writeArea);
                    grid.appendChild(cell);
                });
                
                page.appendChild(grid);
                container.appendChild(page);
            }
        }

        function initCanvas() {
            canvas = document.getElementById('draw-canvas');
            ctx = canvas.getContext('2d');
            
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 8;

            // Pointer events for better pen support
            canvas.addEventListener('pointerdown', handlePointerDown);
            canvas.addEventListener('pointermove', handlePointerMove);
            canvas.addEventListener('pointerup', handlePointerUp);
            canvas.addEventListener('pointerout', handlePointerUp);
            canvas.addEventListener('pointercancel', handlePointerUp);

            // Fallback mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            });

            const brushSize = document.getElementById('brush-size');
            const brushLabel = document.getElementById('brush-size-label');
            brushSize.addEventListener('input', (e) => {
                ctx.lineWidth = e.target.value;
                brushLabel.textContent = e.target.value + 'px';
            });
        }

        function handlePointerDown(e) {
            e.preventDefault();
            
            // Check if it's an eraser (inverted pen/stylus eraser)
            if (e.pointerType === 'pen') {
                showPenIndicator();
                
                // Detect eraser - button value of 32 or 5 typically indicates eraser
                if (e.button === 5 || e.buttons === 32) {
                    if (!isEraserMode) {
                        toggleEraser();
                    }
                } else {
                    if (isEraserMode) {
                        toggleEraser();
                    }
                }
            }
            
            const pos = getMousePos(e);
            isDrawing = true;
            const newStroke = [];
            newStroke.isEraser = isEraserMode;
            currentStrokes.push(newStroke);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            currentStrokes[currentStrokes.length - 1].push(pos);
        }

        function handlePointerMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getMousePos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            currentStrokes[currentStrokes.length - 1].push(pos);
        }

        function handlePointerUp(e) {
            if (isDrawing) {
                isDrawing = false;
                allStrokes.push([...currentStrokes]);
            }
            if (e.pointerType === 'pen') {
                hidePenIndicator();
            }
        }

        function showPenIndicator() {
            const indicator = document.getElementById('pen-indicator');
            if (indicator) {
                indicator.style.display = 'block';
                setTimeout(() => {
                    if (indicator) indicator.style.display = 'none';
                }, 2000);
            }
        }

        function hidePenIndicator() {
            const indicator = document.getElementById('pen-indicator');
            if (indicator) {
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 500);
            }
        }

        function toggleEraser() {
            isEraserMode = !isEraserMode;
            const btn = document.getElementById('eraser-btn');
            const label = document.getElementById('brush-size-label');
            
            if (isEraserMode) {
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-secondary');
                btn.textContent = '‚úèÔ∏è Stift';
                ctx.strokeStyle = '#fff';
                ctx.globalCompositeOperation = 'destination-out';
                label.textContent = 'Radiergr√∂√üe: ' + ctx.lineWidth + 'px';
                canvas.style.cursor = 'pointer';
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                btn.textContent = 'üßπ Radierer';
                ctx.strokeStyle = '#000';
                ctx.globalCompositeOperation = 'source-over';
                label.textContent = 'Pinselgr√∂√üe: ' + ctx.lineWidth + 'px';
                canvas.style.cursor = 'crosshair';
            }
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getMousePos(e);
            const newStroke = [];
            newStroke.isEraser = isEraserMode;
            currentStrokes.push(newStroke);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            currentStrokes[currentStrokes.length - 1].push(pos);
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getMousePos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            currentStrokes[currentStrokes.length - 1].push(pos);
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                allStrokes.push([...currentStrokes]);
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentStrokes = [];
            allStrokes = [];
            
            if (isEraserMode) {
                toggleEraser();
            }
        }

        function undoStroke() {
            if (allStrokes.length > 0) {
                allStrokes.pop();
                redrawCanvas();
            }
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentStrokes = [];
            
            const currentMode = isEraserMode;
            const currentColor = ctx.strokeStyle;
            const currentComposite = ctx.globalCompositeOperation;
            
            allStrokes.forEach(strokeSet => {
                strokeSet.forEach(stroke => {
                    if (stroke.length > 0) {
                        if (stroke.isEraser) {
                            ctx.strokeStyle = '#fff';
                            ctx.globalCompositeOperation = 'destination-out';
                        } else {
                            ctx.strokeStyle = '#000';
                            ctx.globalCompositeOperation = 'source-over';
                        }
                        
                        ctx.beginPath();
                        ctx.moveTo(stroke[0].x, stroke[0].y);
                        stroke.forEach(point => {
                            ctx.lineTo(point.x, point.y);
                        });
                        ctx.stroke();
                        currentStrokes.push(stroke);
                    }
                });
            });
            
            ctx.strokeStyle = currentColor;
            ctx.globalCompositeOperation = currentComposite;
        }

        function canvasToSvg() {
            let svgPaths = '';
            
            allStrokes.forEach(strokeSet => {
                strokeSet.forEach(stroke => {
                    if (stroke.length > 1 && !stroke.isEraser) {
                        let pathData = 'M ' + stroke[0].x + ' ' + stroke[0].y;
                        for (let i = 1; i < stroke.length; i++) {
                            pathData += ' L ' + stroke[i].x + ' ' + stroke[i].y;
                        }
                        svgPaths += '<path d="' + pathData + '" stroke="black" stroke-width="' + ctx.lineWidth + '" fill="none" stroke-linecap="round" stroke-linejoin="round"/>';
                    }
                });
            });

            return '<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ' + canvas.width + ' ' + canvas.height + '" width="' + canvas.width + '" height="' + canvas.height + '">\n' + svgPaths + '\n</svg>';
        }

        function saveCharAndNext() {
            const currentChar = charsToDrawArray[currentCharIndex];
            const svg = canvasToSvg();
            
            if (allStrokes.length > 0) {
                charsSvgData[currentChar] = svg;
                updateDrawnChars();
            }
            
            if (currentCharIndex < charsToDrawArray.length - 1) {
                currentCharIndex++;
                loadChar();
            } else {
                goToStep(4);
            }
        }

        function skipChar() {
            if (currentCharIndex < charsToDrawArray.length - 1) {
                currentCharIndex++;
                loadChar();
            } else {
                goToStep(4);
            }
        }

        function previousChar() {
            if (currentCharIndex > 0) {
                currentCharIndex--;
                loadChar();
            }
        }

        function loadChar() {
            const char = charsToDrawArray[currentCharIndex];
            document.getElementById('current-char').textContent = char;
            document.getElementById('progress-count').textContent = Object.keys(charsSvgData).length;
            
            clearCanvas();
            
            // Load existing drawing if available
            if (charsSvgData[char]) {
                // Show that this character already has a drawing
                const indicator = document.getElementById('current-char');
                indicator.style.color = '#28a745';
                indicator.title = 'Bereits gezeichnet - wird beim Speichern √ºberschrieben';
            } else {
                const indicator = document.getElementById('current-char');
                indicator.style.color = '#667eea';
                indicator.title = '';
            }
            
            updateCharNavigation();
        }

        function updateDrawnChars() {
            const container = document.getElementById('drawn-chars');
            container.innerHTML = '';
            
            // Sort characters by Unicode for display
            const sortedChars = Object.keys(charsSvgData).sort((a, b) => a.charCodeAt(0) - b.charCodeAt(0));
            
            if (sortedChars.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Noch keine Zeichen gezeichnet</p>';
                return;
            }
            
            sortedChars.forEach(char => {
                const preview = document.createElement('div');
                preview.style.cssText = 'width: 65px; height: 65px; border: 3px solid #4caf50; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2.2em; background: white; cursor: pointer; position: relative; transition: all 0.3s; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);';
                preview.textContent = char;
                preview.title = 'Klicken um ' + char + ' zu bearbeiten';
                preview.onclick = () => {
                    currentCharIndex = charsToDrawArray.indexOf(char);
                    loadChar();
                    updateCharNavigation();
                };
                
                // Highlight current character
                if (charsToDrawArray[currentCharIndex] === char) {
                    preview.style.borderColor = '#764ba2';
                    preview.style.borderWidth = '4px';
                    preview.style.boxShadow = '0 4px 16px rgba(118, 75, 162, 0.4)';
                    preview.style.transform = 'scale(1.1)';
                }
                
                preview.addEventListener('mouseenter', () => {
                    if (charsToDrawArray[currentCharIndex] !== char) {
                        preview.style.transform = 'scale(1.15)';
                        preview.style.boxShadow = '0 4px 16px rgba(76, 175, 80, 0.4)';
                    }
                });
                
                preview.addEventListener('mouseleave', () => {
                    if (charsToDrawArray[currentCharIndex] !== char) {
                        preview.style.transform = 'scale(1)';
                        preview.style.boxShadow = '0 2px 8px rgba(76, 175, 80, 0.2)';
                    }
                });
                
                container.appendChild(preview);
            });
        }
        
        function updateCharNavigation() {
            updateDrawnChars();
            updateAllCharsNav();
        }
        
        function updateAllCharsNav() {
            const container = document.getElementById('all-chars-nav');
            if (!container) return;
            
            container.innerHTML = '';
            
            charsToDrawArray.forEach((char, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-secondary';
                btn.style.cssText = 'padding: 8px 12px; font-size: 1.2em; min-width: 45px; margin: 0;';
                btn.textContent = char;
                
                // Visual indicators
                if (index === currentCharIndex) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                    btn.style.transform = 'scale(1.1)';
                } else if (charsSvgData[char]) {
                    btn.style.background = '#d4edda';
                    btn.style.borderColor = '#28a745';
                    btn.style.color = '#155724';
                }
                
                btn.onclick = () => {
                    currentCharIndex = index;
                    loadChar();
                };
                
                container.appendChild(btn);
            });
        }

        function initDrawingStep() {
            charsToDrawArray = Array.from(selectedChars).sort((a, b) => a.charCodeAt(0) - b.charCodeAt(0));
            currentCharIndex = 0;
            document.getElementById('total-count').textContent = charsToDrawArray.length;
            document.getElementById('progress-count').textContent = Object.keys(charsSvgData).length;
            
            if (charsToDrawArray.length > 0) {
                loadChar();
                updateCharNavigation();
            }
        }

        function displayFinalPreview() {
            const grid = document.getElementById('final-preview');
            grid.innerHTML = '';
            
            const chars = Object.keys(charsSvgData).slice(0, 12);
            
            if (chars.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Keine Zeichen gezeichnet. Gehe zur√ºck zu Schritt 3.</p>';
                return;
            }
            
            chars.forEach(char => {
                const preview = document.createElement('div');
                preview.className = 'char-preview';
                
                const svgData = charsSvgData[char];
                const base64 = btoa(unescape(encodeURIComponent(svgData)));
                
                preview.innerHTML = '<img src="data:image/svg+xml;base64,' + base64 + '" alt="' + char + '" style="max-width: 100%; height: 120px; object-fit: contain;"><div class="char-label">' + char + '</div>';
                grid.appendChild(preview);
            });
        }

        function downloadFont() {
            const fontName = document.getElementById('font-name').value || 'Meine Handschrift';
            createZipWithSvgs(fontName);
        }

        async function createZipWithSvgs(fontName) {
            const JSZip = window.JSZip;
            
            if (!JSZip) {
                alert('JSZip wird geladen... Bitte warte einen Moment und versuche es erneut.');
                return;
            }
            
            const zip = new JSZip();
            const svgFolder = zip.folder('svgs');
            
            Object.entries(charsSvgData).forEach(([char, svg]) => {
                const filename = getCharFilename(char);
                svgFolder.file(filename, svg);
            });
            
            const readme = 'Handschrift Font - ' + fontName + '\n\nEnth√§lt ' + Object.keys(charsSvgData).length + ' Zeichen als SVG-Dateien.\n\nSo erstellst du daraus einen Font:\n\nOption 1: FontForge (Open Source)\n1. √ñffne FontForge\n2. Erstelle ein neues Font\n3. Importiere die SVGs: File > Import f√ºr jedes Zeichen\n4. Exportiere als TTF: File > Generate Fonts\n\nOption 2: Glyphs (Mac, kommerziell)\n1. Erstelle ein neues Font\n2. Importiere die SVGs per Drag & Drop\n3. Exportiere als OTF/TTF\n\nOption 3: Online-Service\n- Calligraphr.com (kostenlos bis 75 Zeichen)\n- FontSelf (Adobe Plugin)';
            
            zip.file('README.txt', readme);
            
            const mapping = {};
            Object.keys(charsSvgData).forEach(char => {
                mapping[char] = {
                    filename: getCharFilename(char),
                    unicode: char.charCodeAt(0),
                    unicodeHex: '0x' + char.charCodeAt(0).toString(16).toUpperCase()
                };
            });
            
            zip.file('character-mapping.json', JSON.stringify(mapping, null, 2));
            
            const blob = await zip.generateAsync({ type: 'blob' });
            downloadBlob(blob, fontName.replace(/\s+/g, '-') + '-font-svgs.zip');
            
            alert('‚úÖ ZIP-Datei erstellt!\n\nEnth√§lt:\n- ' + Object.keys(charsSvgData).length + ' SVG-Dateien\n- README mit Anleitung\n- Character-Mapping JSON\n\nNutze FontForge, Glyphs oder Calligraphr.com um den Font zu erstellen.');
        }

        function getCharFilename(char) {
            const code = char.charCodeAt(0);
            
            if (/[A-Za-z0-9]/.test(char)) {
                return char + '.svg';
            }
            
            return 'special_U+' + code.toString(16).toUpperCase() + '.svg';
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            initGrids();
        });
    </script>
</body>
</html>
